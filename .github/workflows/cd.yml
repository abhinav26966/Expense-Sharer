# =============================================================================
# CD Pipeline - Daily Expense Sharing Application
# =============================================================================
# This pipeline handles Continuous Deployment to a Kubernetes cluster.
# Uses Kind (Kubernetes in Docker) for a free, self-contained environment.
#
# Pipeline Stages:
# 1. Deploy - Create Kind cluster and deploy application
# 2. Verify - Ensure pods are running and healthy
# 3. DAST - Dynamic Application Security Testing
# 4. Summary - Generate deployment report
#
# WHY Kind? - Provides a real Kubernetes environment in GitHub Actions
# without requiring external cloud infrastructure or payment.
# In production, replace Kind with GKE/EKS/AKS.
# =============================================================================

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [master, main]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/expense-sharer
  KUBE_NAMESPACE: expense-sharer

jobs:
  # ===========================================================================
  # Stage 1: Deploy to Kubernetes (Kind Cluster)
  # ===========================================================================
  # WHY: Automates deployment and validates Kubernetes manifests.
  # Kind provides a lightweight, real Kubernetes cluster for testing.
  # This demonstrates production deployment patterns without cloud costs.
  # ===========================================================================
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag || 'latest' }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Create Kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: expense-sharer-cluster

      - name: Verify cluster is ready
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          echo ""
          echo "=== Nodes ==="
          kubectl get nodes

      - name: Pull Docker image from DockerHub
        run: |
          echo "Pulling image: ${{ env.DOCKER_IMAGE }}:${{ steps.image-tag.outputs.tag }}"
          docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.image-tag.outputs.tag }}

      - name: Load image into Kind cluster
        run: |
          kind load docker-image ${{ env.DOCKER_IMAGE }}:${{ steps.image-tag.outputs.tag }} --name expense-sharer-cluster

      - name: Validate Kubernetes manifests
        run: |
          echo "=== Validating Kubernetes Manifests ==="
          kubectl apply --dry-run=client -f k8s/namespace.yaml
          kubectl apply --dry-run=client -f k8s/configmap.yaml
          kubectl apply --dry-run=client -f k8s/secret.yaml
          kubectl apply --dry-run=client -f k8s/service.yaml
          echo "âœ“ All manifests are valid!"

      - name: Update deployment with DockerHub image
        run: |
          # Replace local image reference with DockerHub image
          sed -i "s|expense-sharer:latest|${{ env.DOCKER_IMAGE }}:${{ steps.image-tag.outputs.tag }}|g" k8s/deployment.yaml
          sed -i "s|imagePullPolicy: Never|imagePullPolicy: IfNotPresent|g" k8s/deployment.yaml
          echo "Updated deployment.yaml:"
          grep -A2 "image:" k8s/deployment.yaml

      - name: Deploy to Kind cluster
        run: |
          echo "=== Creating Namespace ==="
          kubectl apply -f k8s/namespace.yaml
          
          echo ""
          echo "=== Deploying ConfigMap ==="
          kubectl apply -f k8s/configmap.yaml
          
          echo ""
          echo "=== Deploying Secret ==="
          kubectl apply -f k8s/secret.yaml
          
          echo ""
          echo "=== Deploying Application ==="
          kubectl apply -f k8s/deployment.yaml
          
          echo ""
          echo "=== Creating Service ==="
          kubectl apply -f k8s/service.yaml
          
          echo ""
          echo "âœ“ Deployment Complete!"

      - name: Wait for deployment rollout
        run: |
          echo "Waiting for deployment to be ready..."
          kubectl rollout status deployment/expense-sharer -n ${{ env.KUBE_NAMESPACE }} --timeout=180s

      - name: Verify deployment
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.KUBE_NAMESPACE }} -o wide
          
          echo ""
          echo "=== Service Status ==="
          kubectl get svc -n ${{ env.KUBE_NAMESPACE }}
          
          echo ""
          echo "=== Deployment Status ==="
          kubectl get deployment -n ${{ env.KUBE_NAMESPACE }}
          
          echo ""
          echo "=== All Resources ==="
          kubectl get all -n ${{ env.KUBE_NAMESPACE }}

  # ===========================================================================
  # Stage 2: Verify Deployment & Health Checks
  # ===========================================================================
  # WHY: Validates that the application is actually working after deployment.
  # Tests API endpoints to ensure the container responds correctly.
  # This catches configuration issues before they reach production.
  # ===========================================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag || 'latest' }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Create Kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: expense-sharer-cluster

      - name: Setup application
        run: |
          docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.image-tag.outputs.tag }}
          kind load docker-image ${{ env.DOCKER_IMAGE }}:${{ steps.image-tag.outputs.tag }} --name expense-sharer-cluster
          sed -i "s|expense-sharer:latest|${{ env.DOCKER_IMAGE }}:${{ steps.image-tag.outputs.tag }}|g" k8s/deployment.yaml
          sed -i "s|imagePullPolicy: Never|imagePullPolicy: IfNotPresent|g" k8s/deployment.yaml
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/secret.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Wait for pods to be ready
        run: |
          echo "Waiting for deployment rollout..."
          kubectl rollout status deployment/expense-sharer -n ${{ env.KUBE_NAMESPACE }} --timeout=180s
          
          echo "Waiting for pods to be ready..."
          kubectl wait --for=condition=ready pod -l app=expense-sharer -n ${{ env.KUBE_NAMESPACE }} --timeout=120s

      - name: Run health checks
        run: |
          # Start port forwarding
          kubectl port-forward service/expense-sharer-service 8080:80 -n ${{ env.KUBE_NAMESPACE }} &
          sleep 10
          
          echo "=== Health Check: Home Endpoint ==="
          curl -f http://localhost:8080/ && echo " âœ“ PASSED" || exit 1
          
          echo ""
          echo "=== Health Check: Test Endpoint ==="
          curl -f http://localhost:8080/test && echo " âœ“ PASSED" || exit 1
          
          echo ""
          echo "=== Health Check: Users Endpoint ==="
          curl -f http://localhost:8080/users/ && echo " âœ“ PASSED" || exit 1
          
          echo ""
          echo "=== Health Check: Expenses Endpoint ==="
          curl -f http://localhost:8080/expenses && echo " âœ“ PASSED" || exit 1
          
          echo ""
          echo "âœ“ All health checks passed!"

      - name: Get final deployment status
        if: always()
        run: |
          echo "=== Final Deployment Status ==="
          kubectl get all -n ${{ env.KUBE_NAMESPACE }}

  # ===========================================================================
  # Stage 3: DAST - Dynamic Application Security Testing
  # ===========================================================================
  # WHY: Tests the running application for security vulnerabilities.
  # Unlike SAST (which analyzes code), DAST finds runtime security issues
  # like injection vulnerabilities, authentication bypasses, and misconfigs.
  # ===========================================================================
  dast:
    name: DAST - Security Testing
    runs-on: ubuntu-latest
    needs: [verify]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag || 'latest' }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Create Kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: expense-sharer-cluster

      - name: Deploy application for DAST
        run: |
          docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.image-tag.outputs.tag }}
          kind load docker-image ${{ env.DOCKER_IMAGE }}:${{ steps.image-tag.outputs.tag }} --name expense-sharer-cluster
          sed -i "s|expense-sharer:latest|${{ env.DOCKER_IMAGE }}:${{ steps.image-tag.outputs.tag }}|g" k8s/deployment.yaml
          sed -i "s|imagePullPolicy: Never|imagePullPolicy: IfNotPresent|g" k8s/deployment.yaml
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/secret.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/expense-sharer -n ${{ env.KUBE_NAMESPACE }} --timeout=180s

      - name: Start application for testing
        run: |
          kubectl port-forward service/expense-sharer-service 5000:80 -n ${{ env.KUBE_NAMESPACE }} &
          sleep 10
          curl -f http://localhost:5000/ || exit 1
          echo "Application is ready for DAST"

      - name: Run DAST Security Tests
        run: |
          echo "=============================================="
          echo "   DAST - Dynamic Application Security Testing"
          echo "=============================================="
          echo ""
          
          echo "--- Test 1: SQL Injection Detection ---"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:5000/users/1'OR'1'='1" 2>/dev/null || echo "000")
          if [ "$RESPONSE" == "404" ] || [ "$RESPONSE" == "400" ] || [ "$RESPONSE" == "500" ]; then
            echo "âœ“ SQL Injection properly rejected (HTTP $RESPONSE)"
          else
            echo "âš  Unexpected response to SQL injection attempt (HTTP $RESPONSE)"
          fi
          
          echo ""
          echo "--- Test 2: XSS Prevention ---"
          RESPONSE=$(curl -s -X POST http://localhost:5000/users/ \
            -H "Content-Type: application/json" \
            -d '{"email":"xss@test.com","name":"<script>alert(1)</script>","mobile":"123456"}' \
            -w "\nHTTP_CODE:%{http_code}" 2>/dev/null)
          echo "XSS test completed"
          echo "$RESPONSE" | tail -1
          
          echo ""
          echo "--- Test 3: Security Headers Analysis ---"
          echo "Response Headers:"
          curl -sI http://localhost:5000/ | head -15
          
          echo ""
          echo "--- Test 4: Path Traversal Prevention ---"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:5000/../../../etc/passwd" 2>/dev/null || echo "000")
          echo "Path traversal test: HTTP $RESPONSE"
          
          echo ""
          echo "--- Test 5: HTTP Method Testing ---"
          for METHOD in PUT DELETE PATCH OPTIONS TRACE; do
            RESP=$(curl -s -o /dev/null -w "%{http_code}" -X $METHOD "http://localhost:5000/" 2>/dev/null || echo "000")
            echo "$METHOD: HTTP $RESP"
          done
          
          echo ""
          echo "--- Test 6: Rate Limiting Check ---"
          echo "Sending 20 rapid requests..."
          for i in {1..20}; do
            curl -s -o /dev/null http://localhost:5000/
          done
          FINAL=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/)
          echo "Final request status: HTTP $FINAL"
          
          echo ""
          echo "=============================================="
          echo "   DAST Testing Complete"
          echo "=============================================="

      - name: Generate DAST Report
        run: |
          cat > dast-report.md << 'EOF'
          # DAST Security Test Report
          
          **Application**: Daily Expense Sharing App
          **Date**: $(date)
          **Environment**: Kubernetes (Kind)
          
          ## Tests Performed
          
          | Test | Description | Status |
          |------|-------------|--------|
          | SQL Injection | Attempted SQL injection via URL | Tested |
          | XSS Prevention | Attempted XSS via POST data | Tested |
          | Security Headers | Analyzed response headers | Tested |
          | Path Traversal | Attempted directory traversal | Tested |
          | HTTP Methods | Tested unusual HTTP methods | Tested |
          | Rate Limiting | Sent rapid requests | Tested |
          
          ## Recommendations
          
          1. Add security headers (X-Content-Type-Options, X-Frame-Options)
          2. Implement rate limiting
          3. Add input sanitization
          4. Enable HTTPS in production
          
          ## Notes
          
          This DAST scan was performed as part of the CI/CD pipeline to identify
          potential runtime security vulnerabilities before production deployment.
          EOF

      - name: Upload DAST Report
        uses: actions/upload-artifact@v4
        with:
          name: dast-security-report
          path: dast-report.md

  # ===========================================================================
  # Stage 4: Deployment Summary
  # ===========================================================================
  # WHY: Provides a clear summary of the deployment for auditing and review.
  # Generates GitHub Job Summary with deployment status and details.
  # ===========================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy, verify, dast]
    if: always()

    steps:
      - name: Generate deployment summary
        run: |
          echo "# ðŸš€ CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy to Kubernetes | ${{ needs.deploy.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verify Deployment | ${{ needs.verify.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DAST Security Testing | ${{ needs.dast.result == 'success' && 'âœ… Success' || 'âš ï¸ Check Results' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.DOCKER_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: \`${{ env.KUBE_NAMESPACE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This deployment used **Kind (Kubernetes in Docker)** for demonstration." >> $GITHUB_STEP_SUMMARY
          echo "In production, deploy to managed Kubernetes (GKE/EKS/AKS)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by CD Pipeline*" >> $GITHUB_STEP_SUMMARY
